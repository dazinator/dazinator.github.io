
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Darrell Tunnell&#8217;s Blog</title>
  <meta name="author" content="Darrell Tunnell">

  
  <meta name="description" content="Unit Testing Dynamics CRM Plugins (There is no Spoon CRM) The purpose of this post will be to look at the code for a fairly typical looking crm &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://darrelltunnell.net">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Darrell Tunnell's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49278315-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Darrell Tunnell&#8217;s Blog</a></h1>
  
    <h2>Radiating Awesomeness, One Blog Post at a Time.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:darrelltunnell.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/14/unit-testing-crm-plugins/">Unit Testing Dynamics CRM Plugins</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-14T17:50:00+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>5:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Unit Testing Dynamics CRM Plugins (There is no <del>Spoon</del> CRM)</h2>

<p>The purpose of this post will be to look at the code for a fairly typical looking crm plugin, and examine how to implement a unit test with the least possible effort. Reduced Effort == Reduced Person Hours == Reduced Cost.</p>

<p>Remember, this is Unit Testing, not Integration testing - so at test time - there is no CRM!</p>

<h2>A plugin - and it&rsquo;s requirements</h2>

<p>Firstly, let&rsquo;s look at a plugin that we will call the <code>ReclaimCreditPlugin</code>. Here are the requirements:</p>

<blockquote><ol>
<li>It must run only within a transaction with the database.</li>
<li>When a Contact entity is Updated, if the contact has a parent account, and that parent account is &ldquo;on hold&rdquo; then set the &ldquo;taketheirshoes&rdquo; flag on the contact record to true.</li>
</ol>
</blockquote>

<h2>Developer Jon Doe</h2>

<p>Jon Doe immediately gets to work on writing the plugin for those requirements. He produces the following plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">ReclaimCreditPlugin</span> <span class="p">:</span> <span class="n">IPlugin</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">var</span> <span class="n">executionContext</span> <span class="p">=</span> <span class="p">(</span><span class="n">IPluginExecutionContext</span><span class="p">)</span><span class="n">serviceProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IPluginExecutionContext</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// 1. We must run only within a transaction</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">executionContext</span><span class="p">.</span><span class="n">IsInTransaction</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidPluginExecutionException</span><span class="p">(</span><span class="s">&quot;The plugin detected that it was not running within a database transaction. The plugin requires a database transaction.&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// 2. Get the contact, check its parent account.</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">executionContext</span><span class="p">.</span><span class="n">InputParameters</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;Target&quot;</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">executionContext</span><span class="p">.</span><span class="n">InputParameters</span><span class="p">[</span><span class="s">&quot;Target&quot;</span><span class="p">]</span> <span class="k">is</span> <span class="n">Entity</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Obtain the target entity from the input parameters.</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">contactEntity</span> <span class="p">=</span> <span class="p">(</span><span class="n">Entity</span><span class="p">)</span><span class="n">executionContext</span><span class="p">.</span><span class="n">InputParameters</span><span class="p">[</span><span class="s">&quot;Target&quot;</span><span class="p">];</span>
</span><span class='line'>                <span class="c1">// Get the parent account id.</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">parentAccountId</span> <span class="p">=</span> <span class="p">(</span><span class="n">EntityReference</span><span class="p">)</span><span class="n">contactEntity</span><span class="p">[</span><span class="s">&quot;parentaccountid&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// Get the parent account entity.</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">orgServiceFactory</span> <span class="p">=</span> <span class="p">(</span><span class="n">IOrganizationServiceFactory</span><span class="p">)</span><span class="n">serviceProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IOrganizationServiceFactory</span><span class="p">));</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">orgService</span> <span class="p">=</span> <span class="n">orgServiceFactory</span><span class="p">.</span><span class="n">CreateOrganizationService</span><span class="p">(</span><span class="n">executionContext</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">parentAccountEntity</span> <span class="p">=</span> <span class="n">orgService</span><span class="p">.</span><span class="n">Retrieve</span><span class="p">(</span><span class="s">&quot;account&quot;</span><span class="p">,</span> <span class="n">parentAccountId</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="k">new</span> <span class="n">ColumnSet</span><span class="p">(</span><span class="s">&quot;creditonhold&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>                <span class="kt">var</span> <span class="n">accountOnHold</span> <span class="p">=</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="n">parentAccountEntity</span><span class="p">[</span><span class="s">&quot;creditonhold&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">accountOnHold</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">contactEntity</span><span class="p">[</span><span class="s">&quot;taketheirshoes&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>                    <span class="kt">var</span> <span class="n">tracingService</span> <span class="p">=</span> <span class="p">(</span><span class="n">ITracingService</span><span class="p">)</span><span class="n">serviceProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ITracingService</span><span class="p">));</span>
</span><span class='line'>                    <span class="n">tracingService</span><span class="p">.</span><span class="n">Trace</span><span class="p">(</span><span class="s">&quot;Have indicated that we should take the shoes from contact: {0}&quot;</span><span class="p">,</span> <span class="n">contactEntity</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="err">```</span>
</span><span class='line'>
</span><span class='line'><span class="err">###</span> <span class="n">Good</span> <span class="n">Job</span><span class="p">?</span>
</span><span class='line'><span class="n">Take</span> <span class="n">a</span> <span class="n">moment</span> <span class="n">to</span> <span class="n">peer</span> <span class="n">review</span> <span class="n">the</span> <span class="n">above</span> <span class="n">code</span><span class="p">.</span> <span class="n">Would</span> <span class="n">you</span> <span class="n">vindicate</span> <span class="n">Jon</span> <span class="n">Doe</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">effort</span><span class="p">?</span> <span class="n">It</span> <span class="n">seems</span> <span class="n">it</span> <span class="n">has</span> <span class="n">all</span> <span class="n">the</span> <span class="n">required</span> <span class="n">logic</span> <span class="k">in</span> <span class="n">all</span> <span class="n">the</span> <span class="n">required</span> <span class="n">places</span><span class="p">.</span> <span class="n">It</span> <span class="n">appears</span> <span class="n">he</span> <span class="n">has</span> <span class="n">covered</span> <span class="n">the</span> <span class="n">list</span> <span class="n">of</span> <span class="n">requirements</span><span class="p">.</span> <span class="n">Although</span> <span class="n">Jon</span> <span class="n">doesn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">check</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">current</span> <span class="n">entity</span> <span class="n">being</span> <span class="n">updated</span> <span class="k">is</span> <span class="n">definately</span> <span class="n">a</span> <span class="n">contact</span> <span class="n">entity</span><span class="p">..</span> <span class="n">But</span> <span class="n">within</span> <span class="n">the</span> <span class="n">confines</span> <span class="n">of</span> <span class="k">this</span> <span class="n">blog</span> <span class="n">post</span> <span class="n">we</span> <span class="n">will</span> <span class="n">assume</span> <span class="n">that</span> <span class="n">there</span> <span class="k">is</span> <span class="n">no</span> <span class="n">possible</span> <span class="n">danger</span> <span class="n">that</span> <span class="n">the</span> <span class="n">plugin</span> <span class="n">could</span> <span class="n">ever</span> <span class="n">be</span> <span class="n">registered</span> <span class="n">against</span> <span class="n">the</span> <span class="n">wrong</span> <span class="n">entity</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">So</span><span class="p">..</span> <span class="n">does</span> <span class="n">it</span> <span class="n">actually</span> <span class="n">work</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Does</span> <span class="n">it</span> <span class="n">work</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'><span class="n">Assuming</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">start</span> <span class="n">haemorrhaging</span> <span class="n">people</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">time</span> <span class="n">accross</span> <span class="n">the</span> <span class="n">organisation</span><span class="p">,</span> <span class="n">one</span> <span class="n">way</span> <span class="n">to</span> <span class="n">find</span> <span class="k">out</span> <span class="k">if</span> <span class="k">this</span> <span class="n">code</span> <span class="n">works</span> <span class="k">is</span> <span class="n">to</span> <span class="n">immediately</span> <span class="n">go</span> <span class="n">through</span> <span class="n">the</span> <span class="n">process</span> <span class="n">of</span> <span class="n">deploying</span> <span class="n">it</span> <span class="n">to</span> <span class="n">a</span> <span class="n">QA</span> <span class="n">environment</span><span class="p">,</span> <span class="n">getting</span> <span class="n">someone</span> <span class="n">to</span> <span class="n">test</span> <span class="n">it</span> <span class="n">manually</span><span class="p">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">repeating</span> <span class="n">that</span> <span class="n">cycle</span> <span class="n">of</span> <span class="n">Dev</span> <span class="p">--&gt;</span> <span class="n">Deployment</span> <span class="p">--&gt;</span> <span class="n">QA</span> <span class="k">as</span> <span class="n">often</span> <span class="k">as</span> <span class="n">necessary</span><span class="p">,</span> <span class="n">until</span> <span class="n">the</span> <span class="n">tester</span> <span class="n">gives</span> <span class="n">the</span> <span class="n">thumbs</span> <span class="n">up</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">go</span> <span class="n">that</span> <span class="n">route</span><span class="p">,</span> <span class="n">feel</span> <span class="n">free</span> <span class="n">to</span> <span class="n">skip</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">of</span> <span class="k">this</span> <span class="n">article</span><span class="p">.</span> <span class="n">Otherwise</span> <span class="n">read</span> <span class="n">on</span><span class="p">,</span> <span class="k">where</span> <span class="n">sanity</span> <span class="n">awaits</span><span class="p">!</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Show</span> <span class="n">me</span> <span class="n">a</span> <span class="n">Unit</span> <span class="n">Test</span> <span class="n">Already</span><span class="p">!</span>
</span><span class='line'>
</span><span class='line'><span class="n">Bad</span> <span class="n">news</span> <span class="k">for</span> <span class="n">you</span><span class="p">.</span> <span class="n">I</span> <span class="n">could</span><span class="p">..</span> <span class="n">but</span> <span class="n">I</span> <span class="n">won</span><span class="err">&#39;</span><span class="n">t</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Why</span> <span class="n">won</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">you</span> <span class="n">show</span> <span class="n">me</span> <span class="n">a</span> <span class="n">unit</span> <span class="n">test</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'><span class="n">In</span> <span class="kt">short</span><span class="p">,</span> <span class="n">because</span> <span class="n">I</span> <span class="k">value</span> <span class="n">my</span> <span class="n">time</span><span class="p">.</span> <span class="n">Just</span> <span class="n">look</span> <span class="n">at</span> <span class="n">that</span> <span class="n">code</span> <span class="n">again</span> <span class="k">for</span> <span class="n">crying</span> <span class="k">out</span> <span class="n">loud</span><span class="p">!</span> <span class="n">It</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">littered</span> <span class="n">with</span> <span class="n">dependencies</span> <span class="n">on</span> <span class="n">things</span> <span class="n">that</span> <span class="n">are</span> <span class="n">only</span> <span class="n">provided</span> <span class="n">at</span> <span class="n">runtime</span> <span class="n">by</span> <span class="n">Dynamics</span> <span class="n">CRM</span> <span class="p">-</span> <span class="n">things</span> <span class="n">like</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="m">1.</span> <span class="n">IServiceProvider</span>
</span><span class='line'><span class="m">2.</span> <span class="n">IPluginExecutionContext</span>
</span><span class='line'><span class="m">3.</span> <span class="n">IOrganizationServiceFactory</span>
</span><span class='line'><span class="m">4.</span> <span class="n">IOrganizationService</span>
</span><span class='line'><span class="m">5.</span> <span class="n">ITracingService</span>
</span><span class='line'>
</span><span class='line'><span class="p">**</span><span class="n">WHAT</span> <span class="n">THE</span> <span class="n">HELL</span> <span class="n">ARE</span> <span class="n">ANY</span> <span class="n">OF</span> <span class="n">THESE</span> <span class="n">THINGS</span> <span class="n">TO</span> <span class="n">DO</span> <span class="n">WITH</span> <span class="n">THE</span> <span class="n">ACTUAL</span> <span class="n">REQUIREMENTS</span> <span class="n">THAT</span> <span class="n">I</span> <span class="n">_NEED_</span> <span class="n">TO</span> <span class="n">TEST</span><span class="p">???**</span>
</span><span class='line'>
</span><span class='line'><span class="n">Listen</span><span class="p">..</span> <span class="n">I</span> <span class="n">read</span> <span class="n">those</span> <span class="n">requirements</span> <span class="k">for</span> <span class="k">this</span> <span class="n">plugin</span><span class="p">.</span> <span class="n">I</span> <span class="n">read</span> <span class="n">them</span> <span class="n">atleast</span> <span class="n">one</span> <span class="n">thousand</span> <span class="n">times</span><span class="p">.</span> <span class="n">And</span> <span class="n">I</span> <span class="n">wrote</span> <span class="n">them</span> <span class="k">in</span> <span class="n">fact</span><span class="p">.</span> <span class="n">Here</span> <span class="n">they</span> <span class="n">are</span> <span class="n">again</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;</span> <span class="m">1.</span> <span class="n">It</span> <span class="n">must</span> <span class="n">run</span> <span class="n">only</span> <span class="n">within</span> <span class="n">a</span> <span class="n">transaction</span> <span class="n">with</span> <span class="n">the</span> <span class="n">database</span><span class="p">.</span>
</span><span class='line'><span class="m">2.</span> <span class="n">When</span> <span class="n">a</span> <span class="n">Contact</span> <span class="n">entity</span> <span class="k">is</span> <span class="n">Updated</span><span class="p">,</span> <span class="k">if</span> <span class="n">the</span> <span class="n">contact</span> <span class="n">has</span> <span class="n">a</span> <span class="n">parent</span> <span class="n">account</span><span class="p">,</span> <span class="n">and</span> <span class="n">that</span> <span class="n">parent</span> <span class="n">account</span> <span class="k">is</span> <span class="s">&quot;on hold&quot;</span> <span class="n">then</span> <span class="k">set</span> <span class="n">the</span> <span class="s">&quot;taketheirshoes&quot;</span> <span class="n">flag</span> <span class="n">on</span> <span class="n">the</span> <span class="n">contact</span> <span class="n">record</span> <span class="n">to</span> <span class="k">true</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">So</span> <span class="n">with</span> <span class="n">that</span> <span class="k">in</span> <span class="n">mind</span><span class="p">,</span> <span class="n">can</span> <span class="n">you</span> <span class="n">please</span> <span class="n">show</span> <span class="n">me</span> <span class="n">the</span> <span class="n">requirement</span> <span class="n">dictating</span><span class="p">:</span> <span class="err">`</span><span class="n">When</span> <span class="n">a</span> <span class="n">contact</span> <span class="k">is</span> <span class="n">updated</span><span class="p">,</span> <span class="n">it</span> <span class="k">is</span> <span class="n">of</span> <span class="n">upmost</span> <span class="n">importance</span> <span class="n">to</span> <span class="n">us</span> <span class="k">as</span> <span class="n">a</span> <span class="n">business</span> <span class="n">that</span> <span class="n">it</span> <span class="n">looks</span> <span class="n">at</span> <span class="n">the</span> <span class="err">`</span><span class="n">IPluginExecutionContext</span><span class="err">`</span> <span class="n">and</span> <span class="n">grabs</span> <span class="n">the</span> <span class="err">`</span><span class="n">IOrganizationServiceFactory</span><span class="p">.</span><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="n">Or</span> <span class="n">please</span> <span class="n">show</span> <span class="n">me</span> <span class="k">where</span> <span class="n">the</span> <span class="n">requirements</span> <span class="n">state</span><span class="p">:</span> <span class="err">`</span><span class="n">When</span> <span class="n">a</span> <span class="n">contact</span> <span class="k">is</span> <span class="n">updated</span><span class="p">,</span> <span class="n">the</span> <span class="n">plugin</span> <span class="n">absolutely</span> <span class="n">must</span> <span class="n">interact</span> <span class="n">with</span> <span class="n">the</span> <span class="err">`</span><span class="n">IServiceProvider</span><span class="err">`</span> <span class="n">because</span> <span class="n">otherwise</span> <span class="n">you</span> <span class="n">know</span><span class="p">..</span> <span class="n">Our</span> <span class="n">business</span> <span class="n">just</span> <span class="n">won</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">function</span> <span class="n">anymore</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">No</span> <span class="n">my</span> <span class="n">friends</span><span class="p">.</span> <span class="n">The</span> <span class="n">requirements</span> <span class="k">do</span> <span class="n">not</span> <span class="n">say</span> <span class="n">_any</span> <span class="n">of</span> <span class="n">that_</span><span class="p">.</span> <span class="n">I</span> <span class="n">am</span> <span class="k">in</span> <span class="n">the</span> <span class="n">business</span> <span class="n">of</span> <span class="n">testing</span> <span class="n">against</span> <span class="n">the</span> <span class="n">requirements</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">###</span> <span class="n">Why</span> <span class="k">is</span> <span class="n">that</span> <span class="n">a</span> <span class="n">problem</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'><span class="n">The</span> <span class="n">problem</span> <span class="k">is</span> <span class="n">not</span> <span class="n">obvious</span> <span class="n">at</span> <span class="n">first</span> <span class="n">glance</span><span class="p">.</span> <span class="n">It</span> <span class="k">is</span> <span class="n">definately</span> <span class="n">technically</span> <span class="n">possible</span> <span class="n">to</span> <span class="n">mock</span> <span class="p">/</span> <span class="n">fake</span> <span class="n">all</span> <span class="n">of</span> <span class="n">those</span> <span class="n">services</span> <span class="n">at</span> <span class="n">unit</span> <span class="n">test</span> <span class="n">time</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">use</span> <span class="n">something</span> <span class="n">like</span> <span class="n">RhinoMocks</span> <span class="n">or</span> <span class="n">another</span> <span class="n">Mocking</span> <span class="n">library</span> <span class="n">to</span> <span class="n">mock</span> <span class="k">out</span> <span class="err">`</span><span class="n">IServiceProvider</span><span class="err">`</span> <span class="k">for</span> <span class="n">the</span> <span class="n">purposes</span> <span class="n">of</span> <span class="n">your</span> <span class="n">test</span><span class="p">.</span> <span class="n">You</span> <span class="n">would</span> <span class="n">then</span> <span class="n">have</span> <span class="n">to</span> <span class="n">mock</span> <span class="k">out</span> <span class="n">all</span> <span class="n">the</span> <span class="n">calls</span> <span class="n">to</span> <span class="err">`</span><span class="n">IServiceProvider</span><span class="err">`</span> <span class="n">that</span> <span class="n">are</span> <span class="n">made</span><span class="p">,</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">returns</span> <span class="n">your</span> <span class="n">other</span> <span class="err">&#39;</span><span class="n">mocked</span><span class="err">&#39;</span> <span class="n">services</span> <span class="n">like</span> <span class="n">a</span> <span class="n">mock</span> <span class="err">&#39;</span><span class="n">IPluginExecutionContext</span><span class="err">&#39;</span> <span class="n">etc</span> <span class="n">etc</span> <span class="p">-</span> <span class="n">and</span> <span class="n">down</span> <span class="n">the</span> <span class="n">rabbit</span> <span class="n">hole</span> <span class="n">you</span> <span class="n">go</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">The</span> <span class="n">problem</span><span class="p">,</span> <span class="k">is</span> <span class="n">about</span> <span class="n">_effort_</span><span class="p">.</span> <span class="n">This</span> <span class="n">approach</span><span class="p">,</span> <span class="n">although</span> <span class="n">technically</span> <span class="n">possible</span><span class="p">,</span> <span class="n">requires</span> <span class="n">significant</span> <span class="n">_effort_</span><span class="p">.</span> <span class="n">You</span> <span class="n">would</span> <span class="n">have</span> <span class="n">to</span> <span class="n">mock</span> <span class="n">a</span> <span class="n">tonne</span> <span class="n">of</span> <span class="n">runtime</span> <span class="n">services</span> <span class="n">and</span> <span class="n">interactions</span><span class="p">.</span> <span class="n">We</span> <span class="n">have</span> <span class="n">to</span> <span class="n">ask</span> <span class="n">ourselves</span><span class="p">,</span> <span class="k">is</span> <span class="n">all</span> <span class="n">that</span> <span class="n">effort</span> <span class="n">really</span> <span class="n">necessary</span><span class="p">?</span> <span class="n">Sometimes</span> <span class="n">it</span> <span class="n">may</span> <span class="n">be</span><span class="p">,</span> <span class="n">but</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span><span class="p">,</span> <span class="n">it</span> <span class="n">isn</span><span class="err">&#39;</span><span class="n">t</span><span class="p">.</span> <span class="n">In</span> <span class="k">this</span> <span class="n">instance</span> <span class="n">it</span> <span class="n">definately</span> <span class="n">isn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">and</span> <span class="n">I</span> <span class="n">will</span> <span class="n">explain</span> <span class="n">why</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Let</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">use</span> <span class="n">the</span> <span class="n">requirements</span> <span class="n">to</span> <span class="n">write</span> <span class="n">the</span> <span class="n">plugin</span><span class="p">,</span> <span class="k">in</span> <span class="n">pseudo</span> <span class="n">code</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">With</span> <span class="n">those</span> <span class="n">requirements</span> <span class="p">-</span> <span class="n">forget</span> <span class="n">everything</span> <span class="n">you</span> <span class="n">know</span> <span class="n">about</span> <span class="n">Dynamics</span> <span class="n">Crm</span> <span class="n">and</span> <span class="n">write</span> <span class="n">your</span> <span class="n">ideal</span> <span class="n">pseudo</span> <span class="n">code</span> <span class="n">that</span> <span class="n">would</span> <span class="n">implement</span> <span class="n">those</span> <span class="n">requirements</span><span class="p">.</span> <span class="n">This</span> <span class="k">is</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">logic</span> <span class="n">we</span> <span class="n">care</span> <span class="n">about</span> <span class="n">testing</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">PSEUDO</span> <span class="n">CODE</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>if (!IsRunningInTransaction)
{
    Throw &ldquo;Plugin requires a transaction.&rdquo;
}</p>

<p>If (IsUpdateOf(&ldquo;contact&rdquo;))
{</p>

<p>var contact = GetTargetEntity();
var account = GetAccountForContact(contact);</p>

<p>var isOnHold = (bool)account[&ldquo;creditonhold&rdquo;];
if(isOnHold)
{
    contact[&ldquo;taketheirshoes&rdquo;] = true;
}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="err">##</span> <span class="n">Look</span> <span class="n">at</span> <span class="n">that</span> <span class="n">Pseudo</span> <span class="n">Code</span> <span class="p">-</span>  <span class="n">Do</span> <span class="n">you</span> <span class="n">see</span> <span class="n">_any_</span> <span class="n">runtime</span> <span class="n">services</span><span class="p">?</span>
</span><span class='line'><span class="n">Notice</span> <span class="n">how</span> <span class="n">it</span> <span class="n">contains</span> <span class="n">only</span> <span class="n">the</span> <span class="n">logic</span> <span class="n">we</span> <span class="n">really</span> <span class="n">care</span> <span class="n">about</span> <span class="n">testing</span> <span class="p">-</span> <span class="n">the</span> <span class="n">logic</span> <span class="k">as</span> <span class="n">described</span> <span class="n">by</span> <span class="n">the</span> <span class="n">requirements</span><span class="p">.</span> <span class="n">It</span> <span class="n">doesn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">contain</span> <span class="n">needless</span> <span class="n">fluff</span><span class="p">.</span> <span class="n">No</span> <span class="err">`</span><span class="n">IServiceProvider</span><span class="err">`</span><span class="p">,</span> <span class="n">No</span> <span class="err">`</span><span class="n">IPluginExecutionContext</span><span class="err">`</span><span class="p">.</span> <span class="n">It</span> <span class="n">looks</span> <span class="n">very</span> <span class="n">simple</span><span class="p">,</span> <span class="n">very</span> <span class="n">basic</span><span class="p">.</span> <span class="n">If</span> <span class="n">we</span> <span class="n">could</span> <span class="n">actually</span> <span class="n">write</span> <span class="n">a</span> <span class="n">CRM</span> <span class="n">plugin</span> <span class="n">like</span> <span class="k">this</span><span class="p">,</span> <span class="n">it</span> <span class="n">would</span> <span class="n">be</span> <span class="n">about</span> <span class="m">1.5</span> <span class="n">million</span> <span class="n">times</span> <span class="n">easier</span> <span class="n">to</span> <span class="n">test</span><span class="p">.</span> <span class="n">Well</span> <span class="n">we</span> <span class="n">can</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Isolating</span> <span class="k">out</span> <span class="n">dependencies</span> <span class="k">is</span> <span class="n">the</span> <span class="n">key</span> <span class="n">to</span> <span class="n">unit</span> <span class="n">testing</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">Yes</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> <span class="k">true</span> <span class="n">folks</span> <span class="n">you</span> <span class="n">heard</span> <span class="n">it</span> <span class="n">here</span> <span class="n">first</span><span class="p">.</span> <span class="n">The</span> <span class="n">less</span> <span class="n">dependencies</span> <span class="n">you</span> <span class="n">utilise</span> <span class="n">directly</span> <span class="k">in</span> <span class="n">your</span> <span class="n">methods</span><span class="p">,</span> <span class="n">the</span> <span class="n">easier</span> <span class="n">they</span> <span class="n">are</span> <span class="n">to</span> <span class="n">unit</span> <span class="n">test</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">With</span> <span class="k">this</span> <span class="n">principle</span> <span class="k">in</span> <span class="n">mind</span><span class="p">,</span> <span class="n">let</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">revisit</span> <span class="n">our</span> <span class="n">plugin</span> <span class="n">and</span> <span class="n">refactor</span> <span class="n">it</span> <span class="n">to</span> <span class="k">remove</span> <span class="n">some</span> <span class="n">dependencies</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">New</span> <span class="n">and</span> <span class="n">Improved</span> <span class="n">Plugin</span>
</span></code></pre></td></tr></table></div></figure>


<p> csharp
 public class ReclaimCreditPlugin2 : IPlugin
    {</p>

<pre><code>    private IServiceProvider _ServiceProvider;

    public void Execute(IServiceProvider serviceProvider)
    {
        _ServiceProvider = serviceProvider;
        Execute();
    }

    /// &lt;summary&gt;
    /// This is the method containing the business logic that we want to be able to assert at unit test time.
    /// &lt;/summary&gt;
    public void Execute()
    {
        // 1. We must run only within a transaction
        if (IsInTransaction())
        {
            throw new InvalidPluginExecutionException("The plugin detected that it was not running within a database transaction. The plugin requires a database transaction.");
        }

        // 2. Get the contact
        var contact = GetTargetEntity();

        // 3. Get the Parent Account for the contact.
        var parentAccount = GetAccountEntity(contact);
        if (parentAccount == null)
        {
            return;
        }

        // 4. If credit on hold, set taketheirshoes.
        var accountOnHold = (bool)parentAccount["creditonhold"];
        if (accountOnHold)
        {
            contact["taketheirshoes"] = true;
        }

    }

    /// &lt;summary&gt;
    /// Returns the parent account entity for the contact.
    /// &lt;/summary&gt;
    /// &lt;param name="contact"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    protected virtual Entity GetAccountEntity(Entity contact)
    {
        // Get the p[arent account id.
        var parentAccountId = (EntityReference)contact["parentaccountid"];

        // Get an instance of the IOrganisationService.
        var orgServiceFactory = (IOrganizationServiceFactory)_ServiceProvider.GetService(typeof(IOrganizationServiceFactory));
        var executionContext = (IPluginExecutionContext)_ServiceProvider.GetService(typeof(IPluginExecutionContext));
        var orgService = orgServiceFactory.CreateOrganizationService(executionContext.UserId);

        // Get the account entity, with only the column / attribute that we need.
        var parentAccountEntity = orgService.Retrieve("account", parentAccountId.Id, new ColumnSet("creditonhold"));
        return parentAccountEntity;
    }

    /// &lt;summary&gt;
    /// Returns the current "Target" entity that the plugin is executing against.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    protected virtual Entity GetTargetEntity()
    {
        var context = (IPluginExecutionContext)_ServiceProvider.GetService(typeof(IPluginExecutionContext));
        if (context.InputParameters.Contains("Target") &amp;&amp; context.InputParameters["Target"] is Entity)
        {
            var contactEntity = (Entity)context.InputParameters["Target"];
            return contactEntity;
        }

        return null;
    }

    /// &lt;summary&gt;
    /// Returns whether the plugin is currently enrolled within a database transaction.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    protected virtual bool IsInTransaction()
    {
        var context = (IPluginExecutionContext)_ServiceProvider.GetService(typeof(IPluginExecutionContext));
        return context.IsInTransaction;
    }

}
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="err">##</span> <span class="n">What</span> <span class="n">just</span> <span class="n">happened</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'><span class="n">I</span> <span class="n">applied</span> <span class="n">a</span> <span class="n">technique</span> <span class="n">called</span> <span class="n">the</span> <span class="p">[</span><span class="n">Extract</span> <span class="n">and</span> <span class="n">Override</span><span class="p">](</span><span class="n">http</span><span class="p">:</span><span class="c1">//taswar.zeytinsoft.com/2009/03/08/extract-and-override-refactoring-technique/) technique, to remove the concrete references to all of those CRM runtime only services from within the Execute method, and instead they are now referenced within virtual methods which can be overriden at unit test time.</span>
</span><span class='line'>
</span><span class='line'><span class="n">For</span> <span class="n">example</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">having</span> <span class="n">the</span> <span class="n">following</span> <span class="n">code</span> <span class="n">directly</span> <span class="n">within</span> <span class="n">the</span> <span class="n">execute</span> <span class="n">method</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>  var executionContext = (IPluginExecutionContext)serviceProvider.GetService(typeof(IPluginExecutionContext));</p>

<pre><code>        // 1. We must run only within a transaction
        if (!executionContext.IsInTransaction)
        {
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">It</span> <span class="n">has</span> <span class="n">been</span> <span class="n">replaced</span> <span class="n">by</span> <span class="n">a</span> <span class="n">call</span> <span class="n">to</span> <span class="k">virtual</span> <span class="n">method</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p> chsarp
            if (IsInTransaction())
            {</p>

<pre><code>        }
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Because</span> <span class="n">the</span> <span class="n">interactions</span> <span class="n">with</span> <span class="n">the</span> <span class="n">various</span> <span class="n">CRM</span> <span class="n">runtime</span> <span class="n">Services</span> <span class="n">now</span> <span class="n">occur</span> <span class="n">within</span> <span class="n">Virtual</span> <span class="n">methods</span><span class="p">,</span> <span class="n">we</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">need</span> <span class="n">to</span> <span class="n">mock</span> <span class="n">them</span> <span class="n">up</span> <span class="n">at</span> <span class="n">unit</span> <span class="n">test</span> <span class="n">time</span><span class="p">.</span> <span class="n">Say</span> <span class="n">goodbye</span> <span class="n">to</span> <span class="n">having</span> <span class="n">to</span> <span class="n">mockup</span> <span class="err">`</span><span class="n">IPluginExecutionContext</span><span class="err">`</span><span class="p">,</span> <span class="err">`</span><span class="n">IServiceProvider</span><span class="err">`</span> <span class="n">or</span> <span class="n">_any_</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Crm</span> <span class="n">runtime</span> <span class="n">services</span><span class="p">.</span> <span class="n">All</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="k">do</span> <span class="n">now</span> <span class="k">is</span> <span class="n">just</span> <span class="k">override</span> <span class="n">the</span> <span class="n">various</span> <span class="k">virtual</span> <span class="n">methods</span> <span class="n">that</span> <span class="n">our</span> <span class="n">Execute</span><span class="p">()</span> <span class="n">method</span> <span class="n">calls</span><span class="p">,</span> <span class="n">and</span> <span class="k">return</span> <span class="n">appropriate</span> <span class="n">values</span> <span class="n">at</span> <span class="n">test</span> <span class="n">time</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="err">##</span> <span class="n">Ok</span> <span class="n">so</span> <span class="p">-</span> <span class="n">Now</span> <span class="n">will</span> <span class="n">you</span> <span class="n">show</span> <span class="n">me</span> <span class="n">a</span> <span class="n">Unit</span> <span class="n">Test</span><span class="p">??</span>
</span><span class='line'>
</span><span class='line'><span class="n">Certainly</span> <span class="n">Sir</span> <span class="p">/</span> <span class="n">Madame</span><span class="p">.</span> <span class="n">Now</span> <span class="n">that</span> <span class="n">I</span> <span class="n">can</span> <span class="n">write</span> <span class="n">one</span> <span class="n">within</span> <span class="n">a</span> <span class="n">few</span> <span class="n">minutes</span> <span class="k">as</span> <span class="n">opposed</span> <span class="n">to</span> <span class="n">a</span> <span class="n">few</span> <span class="n">hours</span><span class="p">,</span> <span class="n">your</span> <span class="n">wish</span> <span class="k">is</span> <span class="n">my</span> <span class="n">command</span><span class="p">:-</span>
</span><span class='line'>
</span><span class='line'><span class="n">For</span> <span class="n">the</span> <span class="n">purpose</span> <span class="n">of</span> <span class="n">our</span> <span class="n">unit</span> <span class="n">tests</span> <span class="n">all</span> <span class="n">we</span> <span class="k">do</span><span class="p">,</span> <span class="k">is</span> <span class="n">create</span> <span class="n">a</span> <span class="k">class</span> <span class="nc">that</span> <span class="n">derives</span> <span class="k">from</span> <span class="n">our</span> <span class="n">original</span> <span class="n">plugin</span> <span class="n">class</span><span class="p">,</span> <span class="n">but</span> <span class="n">overrides</span> <span class="n">the</span> <span class="n">various</span> <span class="k">virtual</span> <span class="n">methods</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">different</span> <span class="n">values</span> <span class="n">at</span> <span class="n">test</span> <span class="n">time</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p> csharp
 public class UnitTestableReclaimCreditPlugin : ReclaimCreditPlugin2
    {</p>

<pre><code>    public UnitTestableReclaimCreditPlugin()
    {
        AccountIsOnHold = false;
        IsRunningInTransaction = false;
        ContactEntity = new Entity("contact");
    }

    protected override Entity GetTargetEntity()
    {
        ContactEntity["parentaccountid"] = new EntityReference("account", Guid.NewGuid());
        return ContactEntity;
    }

    protected override Entity GetAccountEntity(Entity contact)
    {
        var accountEntity = new Entity("account");
        accountEntity["creditonhold"] = AccountIsOnHold;
        return accountEntity;
    }

    protected override bool IsInTransaction()
    {
        return IsRunningInTransaction;
    }

    public bool AccountIsOnHold { get; set; }

    public bool IsRunningInTransaction { get; set; }

    public Entity ContactEntity { get; set; }

}
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="err">##</span> <span class="n">And</span> <span class="n">here</span> <span class="n">are</span> <span class="n">the</span> <span class="n">Unit</span> <span class="n">Tests</span>
</span></code></pre></td></tr></table></div></figure>


<p> [TestFixture]
    public class ReclaimCreditPluginUnitTests
    {
        public ReclaimCreditPluginUnitTests()
        {</p>

<pre><code>    }

    [ExpectedException(typeof(InvalidPluginExecutionException),
        ExpectedMessage = "The plugin detected that it was not running within a database transaction",
        MatchType = MessageMatch.Contains)]
    public void Should_Only_Run_Within_Transaction()
    {
        // arrange
        var sut = new UnitTestableReclaimCreditPlugin();
        sut.IsRunningInTransaction = false;

        // act 
        sut.Execute();

    }


    public void Should_Take_Shoes_When_Credit_On_Hold()
    {
        // arrange
        var sut = new UnitTestableReclaimCreditPlugin();
        sut.IsRunningInTransaction = true;
        sut.AccountIsOnHold = true;

        // act 
        sut.Execute();

        //assert
        Assert.That(sut.ContactEntity["taketheirshoes"], Is.EqualTo(true));

    }

    public void Should_Not_Take_Shoes_When_Credit_Not_On_Hold()
    {
        // arrange
        var sut = new UnitTestableReclaimCreditPlugin();
        sut.IsRunningInTransaction = true;
        sut.AccountIsOnHold = false;

        // act 
        sut.Execute();

        //assert
        Assert.That(sut.ContactEntity["taketheirshoes"], Is.Not.EqualTo(true));

    }
}
</code></pre>

<p>&#8220;`</p>

<h2>Wrapping Up</h2>

<p>I hope I have demonstrated a simple plugin, with a simple set of unit tests. More importantly, I hope I have demonstrated that although it may be technically possible to write a unit test for an exising plugin,  by mocking up every CRM runtime service and interaction that the plugin makes,just because such a thing is possible, doesn&rsquo;t mean you should just do it. First the work has to be justified. To justify just what is necessary, examine the requirements, examine the plugin code, and be absolutely clear on what it is you want to cover in your unit tests. With that in mind, refactor the plugin code to eliminate fluff (extraneoues concrete references to dependencies that are surplus to the requirements that you want to test). Use techniques like the <code>Extract and Override</code> technique to allow you to substitute these dependencies easily at test time. When you do this, you may be surprised at how much simpler it becomes to write unit tests. I would aslo reccommend reading a book on unit testing, I found <a href="http://artofunittesting.com/">The Art of Unit Testing</a> very educational on this topic.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/16/a-proclamation/">A Proclamation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-16T16:20:59+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:20 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>On this day the 16th November 2014, let it be known that Darrell&rsquo;s blog was rendered forth unto the internet.</p>

<p>Let the knowledge and manner of its creation also be recorded, lest it be lost from mortal ken. Thus humanity, need not be stricken in ignorance and awe, and need not refer to my blogging website as &ldquo;Witchcraft&rdquo; or &ldquo;Devilry&rdquo;.</p>

<h2>The Mechanism of Creation</h2>

<ol>
<li>Inspiration taken from JakeGinnivan&rsquo;s blog which is powered by OctoPress: <a href="http://jake.ginnivan.net/">http://jake.ginnivan.net/</a></li>
<li>Purchased a domain name: darrelltunnell.net</li>
<li>Followed this OctoPress documentation: <a href="http://octopress.org/docs/setup/">http://octopress.org/docs/setup/</a></li>
<li>Hosted on <a href="https://github.com/">https://github.com/</a></li>
</ol>


<h2>A revelation</h2>

<p>And so it came to pass that Darrell Tunnell&rsquo;s blog was incredibly useful to others. Darrell&rsquo;s blog is currently read by 3.1 million people. Web browser requests for Darrell&rsquo;s blog constitute approximately 85.2% of all browser requests made, worldwide. NetFlix was eventually absorbed into Darrell&rsquo;s Blog at the end of 2014, through internet osmosis.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/14/unit-testing-crm-plugins/">Unit Testing Dynamics CRM Plugins</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/16/a-proclamation/">A Proclamation</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/dazinator">@dazinator</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dazinator',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/darrelltunnell?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Darrell Tunnell -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'darrelltunnellsblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
